<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mecongnghe-DHH Store</title>
    <link rel="stylesheet" href="/public/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="/home.html">
    <script src="/public/js/Checklogin.js"></script>
    <script type="module" src="/js/firebase-config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script type="module" src="/public/js/Delivery.js"></script>
</head>
<body>
    <section class="top">
        <div class="container">
            <div class="row">
                <div class="top-logo">
                    <a href="/home.html"><img src="/public/img/Screenshot_2024-09-28_162555-removebg-preview.png" alt=""></a>
                </div>
                <div class="top-menu-items">
                    <ul>
                        <li>
                            Giáo khoa tham khảo
                            <ul class="top-menu-item">
                                <li><a href="/html-cartegory/manga-comic.html">Manga - Comic</a></li>
                                <li><a href="/html-cartegory/tamly-kinangsong.html">Tâm lý - Kĩ năng sống</a></li>
                                <li><a href="/html-cartegory/sachhocngoaingu.html">Sách học ngoại ngữ</a></li>
                            </ul>
                        </li>
                        <li>
                            VPP - Dụng cụ học sinh
                            <ul class="top-menu-item">
                                <li><a href="/html-cartegory/but-viet.html">Bút - Viết</a></li>
                                <li><a href="/html-cartegory/sanphamvegiay.html">Sản phẩm về giấy</a></li>
                                <li><a href="/html-cartegory/dungcuvanphong.html">Dụng cụ văn phòng</a></li>
                            </ul>
                        </li>
                        <li>
                            Đồ chơi
                            <ul class="top-menu-item">
                                <li><a href="/html-cartegory/dochoigiaoduc.html">Đồ chơi giáo dục</a></li>
                                <li><a href="/html-cartegory/mohinhcacloai.html">Mô hình các loại</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
                <div class="top-menu-icons">
                    <ul>
                        <li>
                            <div class="search-bar" style="display: none;">
                                <input type="text" id="searchInput" placeholder="Nhập từ cần tìm">
                                <button id="searchButton" class="fas fa-search"></button>
                            </div>
                        </li>
                        <li><a href="/login-admin/login.html"><i class="fa-regular fa-user"></i></a></li>
                        <li><a href="/html-cart/cart.html"><i id="cart-icon"class="fas fa-shopping-cart"></i></a><span id="cart-count">0</span></li>                    
                    </ul>
                </div>
            </div>
        </div>
    </section>
    
<!------------------ PRODUCT------------------->
<section class="delivery">
    <div class="container">
        <div class="delivery-top-wrap">
            <div class="delivery-top">
                <div class="delivery-top-delivery delivery-top-item">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="delivery-top-payment delivery-top-item">
                    <i class="fas fa-money-check-alt" style="color:#0DB7EA;"></i>
                </div>
            </div>
        </div>
    

<!-------------------- footer --------------------->
<section class="footer">
    <div class="footer-container">
        <p>Truy cập Fanpage <a href="https://www.facebook.com/profile.php?id=61569810176348" target="_blank">Book Haven Store</a></p>
        <div class="app-google">
            <a href="https://www.apple.com/app-store/" target="_blank"><img src="/img/Screenshot 2024-05-15 003849.png" alt=""></a>
            <a href="https://play.google.com/store/games?hl=vi&pli=1" target="_blank"><img src="/img/Screenshot 2024-05-15 003813.png" alt=""></a>
        </div>
        <div class="footer-items">
            <li><a href="http://online.gov.vn" target="_blank"><img src="/img/Screenshot 2024-05-15 003506.png" alt="" ></a></li>
            <li><a href="tel:0797268602">Liên hệ</a></li>
            <li><a href="">Giới thiệu</a></li>
            <li><a href="https://www.facebook.com/profile.php?id=61569810176348" target="_blank"><i class="fab fa-facebook-f"></i></a><a href="https://mail.google.com/mail/?view=cm&fs=1&to=bookhavenstoresince2024@gmail.com" target="_blank"><i class="fa-solid fa-envelope"></i></a></li>
        </div>
        <div class="footer-text">
            <p></p>
            Địa chỉ đăng ký: 254/5, đường Lê Văn Thọ, phường 11, quận Gò Vấp
            Đặt hàng online: 0797268602
        </div>
        <div class="footer-bottom">
            @ Book Haven Store by BOYS Studio
        </div>
    </div>
</section>
<script src="/js/function.js"></script>
<script type="module">
    import { displayCart, updateQuantity, removeItem } from '/js/cart.js';
    window.updateQuantity = updateQuantity;
    window.removeItem = removeItem;
    //Hello
</script>
<!----------------------------------- Hàm thêm các tỉnh/thành;quận/huyện từ API của GHN ---------------------------->
<script>
    // Hàm tải danh sách tỉnh/thành
    async function loadProvinces() {
        try {   
            const response = await fetch("https://online-gateway.ghn.vn/shiip/public-api/master-data/province", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "Token": "66ce5502-9c0f-11ef-8693-5abc7748e730" // API_Key 
                }
            });
            const data = await response.json();
            
            if (data.code === 200) {
                const provinces = data.data;
                const provinceDropdown = document.getElementById("provinceDropdown");
                
                provinces.forEach(province => {
                    const option = document.createElement("option");
                    option.value = province.ProvinceID;
                    option.text = province.ProvinceName;
                    provinceDropdown.add(option);
                });
            } else {
                console.error("Không thể tải danh sách tỉnh thành", data.message);
            }
        } catch (error) {
            console.error("Lỗi khi gọi API", error);
        }
    }

    // Hàm tải danh sách quận/huyện dựa vào tỉnh/thành đã chọn
    async function loadDistricts(provinceID) {
        try {
            const response = await fetch("https://online-gateway.ghn.vn/shiip/public-api/master-data/district", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Token": "66ce5502-9c0f-11ef-8693-5abc7748e730" // Thay YOUR_API_KEY bằng API Key của bạn
                },
                body: JSON.stringify({ province_id: parseInt(provinceID) })
            });
            const data = await response.json();
            
            if (data.code === 200) {
                const districts = data.data;
                const districtDropdown = document.getElementById("districtDropdown");
                districtDropdown.innerHTML = '<option value="">--Chọn quận/huyện--</option>';
                
                districts.forEach(district => {
                    const option = document.createElement("option");
                    option.value = district.DistrictID;
                    option.text = district.DistrictName;
                    districtDropdown.add(option);
                });
            } else {
                console.error("Không thể tải danh sách quận/huyện:", data.message);
            }
        } catch (error) {
            console.error("Lỗi khi gọi API", error);
        }
    }
    // Gọi hàm loadProvinces khi trang được tải
    document.addEventListener("DOMContentLoaded", loadProvinces);

    // Lắng nghe sự kiện khi người dùng chọn tỉnh/thành để tải quận/huyện
    document.getElementById("provinceDropdown").addEventListener("change", function() {
        const provinceID = this.value;
        if (provinceID) {
            loadDistricts(provinceID);
        } else {
            document.getElementById("district").innerHTML = '<option value="">--Chọn quận/huyện--</option>';
        }
    });
// Khởi tạo Firebase (Đảm bảo đã cấu hình Firebase chính xác)
import { auth,db } from './firebase-config.js';

// Lấy giỏ hàng từ localStorage
function getCart() {
    return JSON.parse(localStorage.getItem('cart')) || [];
}

// Cập nhật bảng giỏ hàng với các sản phẩm
async function updateCartTable() {
    const cart = getCart();
    const cartTable = document.getElementById('cart-table');
    let total = 0;
    let totalQuantity = 0;

    // Xóa các hàng cũ trong bảng
    const rows = cartTable.querySelectorAll('tr');
    rows.forEach((row, index) => {
        if (index > 0) row.remove(); // Bỏ qua dòng tiêu đề
    });

    // Lặp qua các sản phẩm trong giỏ hàng và thêm vào bảng
    for (const item of cart) {
        try {
            // Lấy thông tin sản phẩm từ Firebase
            const docRef = db.collection("products").doc(item.id);
            const doc = await docRef.get();

            if (doc.exists) {
                const product = doc.data();
                const subtotal = product.price * item.quantity; // Tính tiền cho sản phẩm

                // Cập nhật tổng số tiền và số lượng
                total += subtotal;
                totalQuantity += item.quantity;

                // Thêm dòng mới vào bảng
                const row = `
                    <tr>
                        <td>${product.name}</td>
                        <td>${product.discount ? `-${product.discount}%` : 'Không có'}</td>
                        <td>${item.quantity}</td>
                        <td>${subtotal.toLocaleString('vi-VN')}đ</td>
                    </tr>
                `;
                cartTable.innerHTML += row;
            }
        } catch (error) {
            console.error("Error loading product data:", error);
        }
    }

    // Cập nhật tổng số tiền và số lượng
    document.getElementById('total-quantity').textContent = totalQuantity;
    document.getElementById('total-price').textContent = `${total.toLocaleString('vi-VN')}đ`;
    document.getElementById('subtotal-price').textContent = `${total.toLocaleString('vi-VN')}đ`;
}

// Khởi động khi trang tải
document.addEventListener('DOMContentLoaded', updateCartTable);

// Hiển thị giỏ hàng
async function displayCart() {
    try {   
        const cart = getCart();
        const cartContent = document.querySelector('.cart-content-left table tbody');
        const totalQuantityElement = document.getElementById('total-quantity');
        const totalPriceElement = document.getElementById('total-price');
        const subtotalPriceElement = document.getElementById('subtotal-price');

        if (!cartContent) return;
        cartContent.innerHTML = '';

        let total = 0;
        let totalItems = 0;

        for (const item of cart) {
            try {
                const docRef = db.collection("product").doc("sach").collection("comic").doc(item.id);
                const doc = await docRef.get();
                
                if (doc.exists) {
                    const product = doc.data();
                    const subtotal = product.price * item.quantity;
                    total += subtotal;
                    totalItems += item.quantity;

                    const row = `
                        <tr>
                            <td><img src="${product.imageURL}" alt="${product.name}"></td>
                            <td><p>${product.name}</p></td>
                            <td>
                                <div class="quantity-controls">

                                    <input type="number" value="${item.quantity}" min="1" 
                                           onchange="updateQuantity('${item.id}', this.value)">
                                </div>
                            </td>
                            <td><p>${subtotal.toLocaleString('vi-VN')}đ</p></td>
                            <td><button onclick="removeItem('${item.id}')" class="remove-btn">Xóa</button></td>
                        </tr>
                    `;
                    cartContent.innerHTML += row;
                }
            } catch (error) {
                console.error("Error loading product:", error);
            }
        }
    } catch (error) {
        console.error("Error displaying cart:", error);
    }
}

</script>
</body>
</html>